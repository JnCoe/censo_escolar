---
title: "1. Análise inicial"
author: "Jonas Coelho"
date: "07/05/2021"
output: 
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
#Bibliotecas
library('dplyr')
library('kableExtra')

# Gráficos
library(hrbrthemes)
library(viridis)
library(ggplot2)

library(geobr)
library(sf)

library(crul)

`%!in%` <- Negate(`%in%`)

```

# I. Abrindo dados do censo 2020

Vamos iniciar com os microdados do censo que podem ser obtidos nesse endereço: https://www.gov.br/inep/pt-br/acesso-a-informacao/dados-abertos/microdados/censo-escolar . Note que o arquivo possui 2GB e pode levar horas para ser baixado mesmo em boa conexão.

Primeiramente, vamos importar os dicionários disponíveis na pasta de anexos:

```{r message=FALSE, warning=FALSE}
dici_escolas <- readxl::read_excel('../dados/dicionario.xlsx', sheet = 'BAS_ESCOLA', skip = 7) %>%
  janitor::clean_names() %>%
  slice(3:n())
```

Agora visualizar:

```{r}
dici_escolas %>%
    knitr::kable("html") %>%
    kable_styling() %>%
    scroll_box(width = "100%", height = "500px")
```

É possível notar que há diversas colunas. Pelas colunas, é possível notar que a base também é bastante extensa, possuindo escolas de EJA, Ensino Fundamental, Médio, Instituições de Atividades Complementares (como clubes), EAD, entre outras, além de instituições públicas e privadas.Como consequência, um comparativo entre estados/municípios sem levar em conta essas particularidades poderia acabar sendo espúrio. 

Por esse motivo, vamos realizar uma filtragem para manter apenas as instituições de ensino regular (creche a ensino médio). Para isso, realizaremos o filtro na coluna "in_regular == 1". Também vamos excluir as escolas que possuem exclusivamente atividade complementar (tp_atividade_complementar != 2). Vamos também criar tabelas separadas de escolas públicas e particulares para facilitar a análise.

```{r}
escolas_todas <- data.table::fread('../dados/escolas.CSV', sep = '|') %>%
  janitor::clean_names()

escolas <- escolas_todas %>%
  filter(in_regular == 1 & tp_atividade_complementar != 2)

escolas_pub <- escolas %>%
  filter(tp_dependencia == 1 | tp_dependencia == 2 | tp_dependencia == 3)

escolas_priv <- escolas %>%
  filter(tp_dependencia == 4)
```

Há um problema nisso, no entanto, essas colunas não estão 100% preenchidas. É possível notar que há escolas não preenchidas nessa coluna com nome como "EMEF" e "EMEI", o que provavelmente indica que se trata de um ensino regular. Vamos analisar como estão os NAs.


# II. Análise do dados de infraestrutura

As colunas mais interessantes para nossa análise são:

* IN_AGUA_POTAVEL (Fornece água potável para o consumo humano)
* IN_AGUA_INEXISTENTE (Abastecimento de água - Não há abastecimento de água)
* IN_ESGOTO_INEXISTENTE (Esgoto sanitário - Não há esgotamento sanitário)
* IN_AREA_VERDE (Dependências físicas existentes e utilizadas na escola - Área Verde)
* IN_BANHEIRO (Dependências físicas existentes e utilizadas na escola - Banheiro)
* IN_BANHEIRO_FUNCIONARIOS (Dependências físicas existentes e utilizadas na escola - Banheiro exclusivo para os funcionários)
* IN_PATIO_COBERTO (Dependências físicas existentes e utilizadas na escola - Pátio Coberto)
* IN_PATIO_DESCOBERTO (Dependências físicas existentes e utilizadas na escola - Pátio Descoberto)
* IN_INTERNET_ADMINISTRATIVO (Acesso à Internet - Para uso administrativo)
* IN_BANDA_LARGA (Internet Banda Larga)
* QT_PROF_SAUDE	 (Total de profissionais que atuam na escola - Bombeiro(a) brigadista, profissionais de assistência a saúde (urgência e emergência), Enfermeiro(a), Técnico(a) de enfermagem e socorrista)

Vamos fazer um sumário desses dados:

```{r}
fun_sumar <- function(z) {
  cache <- as.data.frame(matrix(ncol = 6, nrow = 0))
  colunas <- c('NAs', 'prop_na', 'zeros', 'prop_zero', 'uns', 'prop_uns')
  colnames(cache) <- colunas
  
  z <- z %>%
    select(in_agua_potavel, in_agua_inexistente, in_esgoto_inexistente, in_area_verde, in_banheiro, in_banheiro_funcionarios, in_patio_coberto, in_patio_descoberto, in_internet_administrativo, in_banda_larga, qt_prof_saude)

  for (i in names(z)){
    x <- z %>%
      select(i)
    
    y <- x %>%
      summarise(coluna = i,
                NAs = sum(is.na(.)),
                prop_na = round(sum(is.na(.))/n(), digits = 2),
                zeros = sum(. ==  0, na.rm = TRUE),
                prop_zero = round(sum(. ==  0, na.rm = TRUE)/n(), digits = 2),
                uns = sum(. ==  1, na.rm = TRUE),
                prop_uns = round(sum(. ==  1, na.rm = TRUE)/n(), digits = 2))
    cache <- rbind(cache, y)
  }

  return(cache)
}
```

```{r}
sumario <- fun_sumar(escolas)
```

```{r}
sumario %>%
  knitr::kable("html") %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

Nenhuma das escolas do censo está com os campos de infraestrutura não preenchido, com exceção da coluna de banda larga, em que 20% das escolas não preencheram a coluna.

Uma observação relevante que vale ser relembrada é que as colunas "in_agua_inexistente" e "in_esgoto_inexistente", por indicarem a ausência de água esgoto, idealmente devem ser "0", enquanto as demais, por indicarem presença, devem ser "1".

Antes de analisarmos mais a fundo o retrato da infraestrutura escolar no Brasil, vamos verificar como fica a distribuição geográfica dessas variáveis:

```{r}
equivalencia <- data.frame(co_regiao = c(1,2,3,4,5),
                           regiao = c('norte', 'nordeste', 'sudeste', 'sul', 'centro-oeste'))
```


```{r}

#------- Região

sumario2 <- escolas %>%
    filter(co_regiao == 1) %>%
    fun_sumar() %>%
  mutate(co_regiao = 1)

for (i in 2:5){
  cache <- escolas %>%
    filter(co_regiao == i) %>%
    fun_sumar() %>%
  mutate(co_regiao = i)
  
  sumario2 <- rbind(sumario2, cache)
}

sumario2 <- sumario2 %>%
  left_join(equivalencia)

#----- Estados

ufs <- escolas %>%
  distinct(co_uf) %>%
  as.list()


sumar_estados <- function(x){
  cont <- 0
  for (i in ufs[[1]]){
    cache2 <- x %>%
      filter(co_uf == i) %>%
      fun_sumar() %>%
      mutate(co_uf = toString(i))
  
    if (cont == 0){
      sumario3 <- cache2
    } else {
      sumario3 <- rbind(sumario3, cache2)
    }
  
    cont <- 1
  }
  return(sumario3)
}

sumario3 <- sumar_estados(escolas) %>%
  mutate(code_state = as.double(co_uf))
```

```{r teste15}
no_axis <- theme(axis.title=element_blank(),
                   axis.text=element_blank(),
                   axis.ticks=element_blank())
```

```{r teste2, warning=FALSE, results='hide',message=FALSE}
states <- read_state(year=2019)

states <- left_join(states, sumario3)

sumario_pub <- sumar_estados(escolas_pub) %>%
  mutate(code_state = as.double(co_uf))

states_pub <- left_join(states, sumario_pub)
  
sumario_priv <- sumar_estados(escolas_priv) %>%
  mutate(code_state = as.double(co_uf))

states_priv <- left_join(states, sumario_priv)
```

```{r teste0, message=FALSE, warning=FALSE}
par(mfrow=c(2,2))
states %>%
  filter(coluna == 'in_agua_inexistente') %>%
  mutate(prop_preenchida_sem_agua = 1 - (zeros/(zeros+uns))) %>%
  ggplot() +
    geom_sf(aes(fill=prop_preenchida_sem_agua), color= '#000000', size=.15) +
      labs(subtitle="Proporção em % de escolas sem acesso a água", size=8) +
      scale_fill_distiller(palette = "Spectral", name="Proporção") +
      theme_minimal() +
      no_axis

states %>%
  filter(coluna == 'in_esgoto_inexistente') %>%
  mutate(prop_preenchida_sem_agua = 1 - (zeros/(zeros+uns))) %>%
  ggplot() +
    geom_sf(aes(fill=prop_preenchida_sem_agua), color= '#000000', size=.15) +
      labs(subtitle="Proporção em % de escolas sem acesso a esgoto", size=8) +
      scale_fill_distiller(palette = "Spectral", name="Proporção") +
      theme_minimal() +
      no_axis

states %>%
  filter(coluna == 'in_agua_potavel') %>%
  mutate(prop_preenchida_sem_agua = zeros/(zeros+uns)) %>%
  ggplot() +
    geom_sf(aes(fill=prop_preenchida_sem_agua), color= '#000000', size=.15) +
      labs(subtitle="Proporção em % de escolas sem acesso a água potável", size=8) +
      scale_fill_distiller(palette = "Spectral", name="Proporção") +
      theme_minimal() +
      no_axis

states %>%
  filter(coluna == 'in_area_verde') %>%
  mutate(prop_preenchida_sem_agua = zeros/(zeros+uns)) %>%
  ggplot() +
    geom_sf(aes(fill=prop_preenchida_sem_agua), color= '#000000', size=.15) +
      labs(subtitle="Proporção em % de escolas sem área verde", size=8) +
      scale_fill_distiller(palette = "Spectral", name="Proporção") +
      theme_minimal() +
      no_axis

states %>%
  filter(coluna == 'in_banda_larga') %>%
  mutate(prop_preenchida_sem_agua = zeros/(zeros+uns)) %>%
  ggplot() +
    geom_sf(aes(fill=prop_preenchida_sem_agua), color= '#000000', size=.15) +
      labs(subtitle="Proporção em % de escolas sem banda larga (desconsiderando NA)", size=8) +
      scale_fill_distiller(palette = "Spectral", name="Proporção") +
      theme_minimal() +
      no_axis

states %>%
  filter(coluna == 'in_patio_coberto' | coluna == 'in_patio_coberto') %>%
  group_by(co_uf) %>%
  summarise(soma_zeros = sum(zeros),
            soma_uns = sum(uns)) %>%
  mutate(prop_preenchida_sem_agua = soma_zeros/(soma_zeros+soma_uns)) %>%
  ggplot() +
    geom_sf(aes(fill=prop_preenchida_sem_agua), color= '#000000', size=.15) +
      labs(subtitle="Proporção em % de escolas sem pátio coberto", size=8) +
      scale_fill_distiller(palette = "Spectral", name="Proporção") +
      theme_minimal() +
      no_axis

states %>%
  filter(coluna == 'in_patio_descoberto' | coluna == 'in_patio_coberto') %>%
  group_by(co_uf) %>%
  summarise(soma_zeros = sum(zeros),
            soma_uns = sum(uns)) %>%
  mutate(prop_preenchida_sem_agua = soma_zeros/(soma_zeros+soma_uns)) %>%
  ggplot() +
    geom_sf(aes(fill=prop_preenchida_sem_agua), color= '#000000', size=.15) +
      labs(subtitle="Proporção em % de escolas sem pátio descoberto", size=8) +
      scale_fill_distiller(palette = "Spectral", name="Proporção") +
      theme_minimal() +
      no_axis
```

```{r}
save(sumario, file = '../apps/dados/sumario.rdata')
save(sumario2, file = '../apps/dados/sumario.rdata2')
save(sumario3, file = '../apps/dados/sumario.rdata3')
save(states, file = '../apps/dados/states.RData')
```

A tabela completa com os valores por estados pode ser explorada no endereço:
https://jcoelho.shinyapps.io/tabela_estados/

Antes de prosseguir, é importante verificar o quão realistas as informações prestadas são. Foram identificados alguns casos que os dados do censo não condizem com a estrutura da instituição.

Por exemplo, o Instituto de Educação de Minas Gerais (cód.: 31001996) diz não possuir pátio coberto ou descoberto bem como não possuir auditório. Porém, sabe-se que o edifício possui pátios, como é possível inclusive observar das imagens:

![Foto aérea](https://i.imgur.com/JmAoBr9.png)

bem como um auditório:

![Foto auditório](https://i.imgur.com/E2fWzsl.png)

Por fim, houve o caso também da escola EE Angelo Correia Viana (cód.: 31317357), que informava possuir apenas uma sala utilizada. Ao ligar para a escola no entanto, a diretora informou que o número de salas utilizadas era 12.

No caso do Rio, foi possível notar que uma escola particular que oferece ensino fundamental ao médio está cadastrada como duas instituições diferentes. Como consequência, o número de salas informadas, mesmo somando, está consideravelmente abaixo do total existente na instituição.

É relevante, portanto, entender que as informações prestadas podem não ser um retrato 100% fiel da situação das escolas.

Feitas essas considerações, passamos para a análise dos dados obtidos:

# III. Análise por estado

Não surpreendentemente, há uma grande disparidade regional no acesso a infraestrutura, com estados do norte e nordeste liderando na falta de água e esgoto. O Rio Grande do Sul se destaca por ser o único estado fora dessas duas regiões entre os 10 estados com maior proporção de escolas sem acesso à água potável. Com 22% de escolas nessa situação, o estado gaúcho é o terceiro pior colocado no Brasil. Se forem consideradas apenas as escolas públicas, esse valor sobe para 29%. Mais alarmante, no entanto, é o estado de Roraima, com quase 40% das escolas sem acesso a água potável.

Ainda assim, ambos estados ao menos possuem acesso à água, o que pode ser fundamental em um contexto de pandemia para questões de higiene. No estado do Acre, porém, 417 escolas (27% do total e 28% das escolas públicas) afirmaram ao censo que não possuem acesso à nenhuma fonte de água. Esse número está consideravelmente acima do segundo estado com a maior proporção de escolas sem água (Maranhão, com 8%).

Há, no entanto, um fato curioso. Algumas escolas estão com "água potavel" marcado como "1" e "in_agua_inexistente" também marcado como "1", ou seja, a escola informa não possuir acesso a nenhuma fonte de água, mas que possui água potável.

A escola NORBERTO ASSUNCAO CAVALCANTE (cód.: 12001104), no catálogo de escolas do INEP consta como "Abastecimento de água" preenchido por "Cacimba/Cisterna/Poço" bem como "Água consumida pelos alunos" preenchido por "Potável". Mais especificamente, 2147 escolas nessa situação. Só no Acre, 127 das 417 escolas sem acesso a água alegam ter água potável.

Não só isso, a [página](http://idebescola.inep.gov.br/ideb/escola/dadosEscola/12001104) de indicadores das Escolas do INEP diz que o abastecimento da escola é feito por "Cacimba/Cisterna/Poço", mesmo com os dados do censo indicando que não há abastecimento em nenhuma forma, nem mesmo os citados:

```{r}
escolas %>%
  filter(co_entidade == '12001104') %>%
  knitr::kable("html") %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "200px")
```

É uma possibilidade que os valores preenchidos, principalmente no Acre, estejam incorretos, ao menos em parte. Esse ponto deve ser considerado para análises macro usando os dados.

# V. Dados apenas públicas

```{r}
sumario_pub <- fun_sumar(escolas_pub)
```

```{r}
sumario_pub %>%
  knitr::kable("html") %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```

# V. Diferenças públicas x privadas

Há 4 opções para a coluna TP_DEPENDENCIA:
1 - Federal
2 - Estadual
3 - Municipal
4 - Privada

Vamos criar uma coluna com os equivalentes para facilitar a leitura:


```{r}
escolas2 <- escolas %>%
  mutate(Tipo = case_when(tp_dependencia == 1 ~ 'Federal', tp_dependencia == 2 ~ 'Estadual', tp_dependencia == 3 ~ 'Municipal', tp_dependencia == 4 ~ 'Privada' ))
```

```{r}
escolas2 %>%
group_by(co_uf) %>%
  left_join(states, by = c('co_uf' = 'code_state')) %>%
mutate(total_de_escolas = n()) %>%
group_by(name_state, Tipo) %>%
summarise(n_escolas_sem_esgoto = sum(as.numeric(in_esgoto_inexistente)), total_de_escolas = total_de_escolas) %>%
unique() %>%
ggplot(aes(fill=Tipo, y=n_escolas_sem_esgoto, x=reorder(name_state, n_escolas_sem_esgoto))) +
geom_bar(position="stack", stat="identity") +
coord_flip() +
xlab('UF') +
ylab('Escolas sem esgoto') +
  ggtitle('Número absoluto de escolas sem esgoto')

escolas2 %>%
group_by(co_uf) %>%
  left_join(states, by = c('co_uf' = 'code_state')) %>%
mutate(total_de_escolas = n()) %>%
group_by(name_state, Tipo) %>%
summarise(n_escolas_sem_esgoto = sum(as.numeric(in_esgoto_inexistente)), total_de_escolas = total_de_escolas) %>%
mutate(prop_sem_esgoto = n_escolas_sem_esgoto/total_de_escolas) %>%
unique() %>%
  ggplot(aes(fill=Tipo, y=prop_sem_esgoto, x=reorder(name_state, prop_sem_esgoto))) +
geom_bar(position="stack", stat="identity") +
coord_flip() +
xlab('UF') +
ylab('Escolas sem esgoto') +
scale_y_continuous(labels = scales::percent) +
  ggtitle('Proporção de escolas sem esgoto')

escolas2 %>%
group_by(co_uf) %>%
  left_join(states, by = c('co_uf' = 'code_state')) %>%
mutate(total_de_escolas = n()) %>%
group_by(name_state, Tipo) %>%
summarise(n_escolas_sem_agua = sum(as.numeric(in_agua_inexistente)), total_de_escolas = total_de_escolas) %>%
unique() %>%
ggplot(aes(fill=Tipo, y=n_escolas_sem_agua, x=reorder(name_state, n_escolas_sem_agua))) +
geom_bar(position="stack", stat="identity") +
coord_flip() +
xlab('UF') +
ylab('Escolas sem água') +
  ggtitle('Número absoluto de escolas sem água')
  
escolas2 %>%
group_by(co_uf) %>%
  left_join(states, by = c('co_uf' = 'code_state')) %>%
mutate(total_de_escolas = n()) %>%
group_by(name_state, Tipo) %>%
summarise(n_escolas_sem_agua = sum(as.numeric(in_agua_inexistente)), total_de_escolas = total_de_escolas) %>%
mutate(prop_sem_esgoto = n_escolas_sem_agua/total_de_escolas) %>%
unique() %>%
  ggplot(aes(fill=Tipo, y=prop_sem_esgoto, x=reorder(name_state, prop_sem_esgoto))) +
geom_bar(position="stack", stat="identity") +
coord_flip() +
xlab('UF') +
ylab('Escolas sem água') +
scale_y_continuous(labels = scales::percent) +
  ggtitle('Proporção de escolas sem água')  
  
```
Tabelas com as informações acima

## Número absoluto de escolas sem esgoto
```{r}
escolas2 %>%
group_by(co_uf) %>%
  left_join(states, by = c('co_uf' = 'code_state')) %>%
mutate(total_de_escolas = n()) %>%
group_by(name_state, Tipo) %>%
summarise(n_escolas_sem_esgoto = sum(as.numeric(in_esgoto_inexistente)), total_de_escolas = total_de_escolas) %>%
unique()
```

## Proporção de escolas sem esgoto

```{r}
escolas2 %>%
group_by(co_uf) %>%
  left_join(states, by = c('co_uf' = 'code_state')) %>%
mutate(total_de_escolas = n()) %>%
group_by(name_state, Tipo) %>%
summarise(n_escolas_sem_esgoto = sum(as.numeric(in_esgoto_inexistente)), total_de_escolas = total_de_escolas) %>%
mutate(prop_sem_esgoto = n_escolas_sem_esgoto/total_de_escolas) %>%
unique()
```

## Número absoluto de escolas sem água

```{r}
escolas2 %>%
group_by(co_uf) %>%
  left_join(states, by = c('co_uf' = 'code_state')) %>%
mutate(total_de_escolas = n()) %>%
group_by(name_state, Tipo) %>%
summarise(n_escolas_sem_agua = sum(as.numeric(in_agua_inexistente)), total_de_escolas = total_de_escolas) %>%
unique()
```


## Proporção de escolas sem água
```{r}
escolas2 %>%
group_by(co_uf) %>%
  left_join(states, by = c('co_uf' = 'code_state')) %>%
mutate(total_de_escolas = n()) %>%
group_by(name_state, Tipo) %>%
summarise(n_escolas_sem_agua = sum(as.numeric(in_agua_inexistente)), total_de_escolas = total_de_escolas) %>%
mutate(prop_sem_esgoto = n_escolas_sem_agua/total_de_escolas) %>%
unique()
```

